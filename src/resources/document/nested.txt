DELETE test_nested_index
PUT test_nested_index
{
    "mappings":{
        "test_nested_type":{
            "dynamic":"false",
            "_all":{
                "enabled":false
            },
            "properties":{
                "address":{
                    "type":"nested",
                    "properties":{
                        "state":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "street":{
                            "type":"string",
                            "index":"not_analyzed"
                        }
                    }
                },
                "user":{
                    "type":"nested",
                    "properties":{
                        "a":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "b":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "c":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "d":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "first":{
                            "type":"string",
                            "index":"not_analyzed"
                        },
                        "last":{
                            "type":"string",
                            "index":"not_analyzed"
                        }
                    }
                }
            }
        },
        "aliases":{
        }
    }
}

POST test_nested_index/test_nested_type
{
    "user":[
        {
            "first":"f1",
            "last":"l1"
        },
        {
            "first":"f2",
            "last":"l2"
        },
         {
             "first":"f3",
             "last":"l3",
             "a":"av",
             "b":"bv",
             "c":"cv",
             "d":"dv"
         },
        {
            "a":"av",
            "b":"bv",
            "c":"cv",
            "d":"dv"
        }
    ],
    "address":[
        {
            "state":"shandong",
            "street":"gaotun"
        },
        {
            "state":"jiangshu",
            "street":"nanjing"
        }
    ]
}


GET test_nested_index/test_nested_type/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "first_level": {
      "nested": {
        "path": "address"
      }
      , "aggs": {
        "second": {
          "terms": {
            "field": "address.state",
            "size": 10
          }
        }
      }
    }
  }
}